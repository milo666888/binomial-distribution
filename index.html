<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>äºŒé …åˆ†å¸ƒæ¨¡æ“¬å™¨ï¼ˆæ•¸ä½é«˜çˆ¾é “æ¿ï¼‰</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--accent:#38bdf8;--accent2:#f87171;--text:#e5e7eb;--muted:#94a3b8}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
  background:linear-gradient(180deg,#0b1025 0%, #0f172a 60%, #0b1025 100%);
  font-size:15px;
}

/* Header */
header{position:relative;padding:12px 12px 8px}
h1{
  margin:0;text-align:center;font-weight:800;letter-spacing:.02em;color:#f0f9ff;
  font-size:clamp(1.35rem,1.9vw,1.85rem);
}
.tools{position:absolute;right:12px;top:10px;display:flex;gap:10px}
#btnMusic{
  display:grid;place-items:center;width:36px;height:36px;border-radius:10px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(2,6,23,.5);color:#e5e7eb;font-size:1.05rem;cursor:pointer
}
#btnMusic.off{opacity:.7;text-decoration:line-through}

/* Layoutï¼ˆæ¡Œæ©Ÿä¿æŒä¸å‹•ï¼‰ */
.wrap{
  width:min(96vw,1500px);
  margin:8px auto 24px;
  padding:0 12px;
  display:grid;
  grid-template-columns: 1fr 320px;
  gap:12px;
}
.panel{
  background:rgba(31,41,55,.85);border:1px solid rgba(148,163,184,.2);
  border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);backdrop-filter:blur(6px);
  padding:12px
}
.canvas-wrap{
  position:relative;padding:10px 10px 4px 10px;
  border-radius:12px;
  background:
    radial-gradient(1000px 360px at 50% -40%, rgba(56,189,248,.15), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
  border:1px solid rgba(148,163,184,.2)
}
#board{display:block;width:100%;height:46vh;border-radius:10px;background:#0a0f1f}
#chart{display:block;width:100%;height:22vh;border-radius:10px;background:#0b1224}

.legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:.9rem;margin-top:2px;flex-wrap:wrap}
.dot{width:10px;height:10px;border-radius:999px;display:inline-block}
.bar{background:var(--accent)} .line{background:var(--accent2)}

.stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:4px}
.stat{padding:6px 8px;border-radius:10px;background:rgba(2,6,23,.4);border:1px solid rgba(148,163,184,.2)}
.stat .k{font-size:.85rem;color:var(--muted)}
.stat .v{font-weight:800;font-size:1rem}

/* Controls */
.controls{padding:12px;display:grid;gap:12px;background:rgba(2,6,23,.35);border:1px dashed rgba(148,163,184,.25);border-radius:12px}
.control{display:grid;gap:8px}
.control label{font-size:.9rem;color:var(--muted)}
.control input[type=number]{background:var(--card);color:var(--text);border:1px solid rgba(148,163,184,.35);border-radius:8px;padding:6px 8px;font-size:.95rem}
.range{appearance:none;width:100%;height:6px;border-radius:6px;background:rgba(148,163,184,.22)}
.range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent)}
.range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);border:none}
.btns{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
.btn{
  appearance:none;border:1px solid rgba(148,163,184,.35);
  background:linear-gradient(180deg,rgba(56,189,248,.18),rgba(56,189,248,.08));
  color:#e6f7ff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;font-size:.95rem
}
.btn.warn{background:linear-gradient(180deg,rgba(248,113,113,.22),rgba(248,113,113,.10));border-color:rgba(248,113,113,.45);color:#ffecec}

/* Company logo (desktop) */
.logo-fixed{
  position:fixed;right:16px;bottom:16px;width:90px;height:auto;opacity:.95;
  filter:drop-shadow(0 6px 16px rgba(0,0,0,.45));pointer-events:none;z-index:1200
}

/* Mobileï¼ˆåªå‹•é€™è£¡ï¼‰ */
#sheetBackdrop{display:none}
.mobile-float{display:none}
@media (max-width:980px),(hover:none) and (pointer:coarse){
  /* æ¨™é¡Œç´„ 70% */
  header h1{font-size:0.84rem}

  .wrap{grid-template-columns:1fr;width:96vw}
  .panel{padding:8px}
  .canvas-wrap{padding:6px 6px 4px 6px}
  .legend{margin-top:4px}.stats{margin-top:4px}
  #board{width:100%;height:48svh;height:48dvh}  /* å…ˆç”¨ svhï¼ŒJS å†ç²¾æº–å£“åˆ° 50% */
  #chart{width:100%;height:24svh;height:24dvh}

  /* æŠ½å±œ */
  .controls-panel{position:fixed;left:0;right:0;bottom:0;z-index:1700;max-height:85svh;
    transform:translateY(105%);transition:transform .25s ease;border-radius:16px 16px 0 0;
    backdrop-filter:blur(8px);overflow:hidden;padding-top:6px}
  .controls-panel.open{transform:translateY(0)}
  .controls{max-height:60svh;overflow:auto;-webkit-overflow-scrolling:touch}
  .btns{position:sticky;bottom:0;background:rgba(2,6,23,.55);border-top:1px solid rgba(148,163,184,.15);padding-top:8px}
  .sheet-head{display:flex;justify-content:space-between;align-items:center;padding:6px 12px 2px}
  .sheet-title{font-weight:800}
  .sheet-close{appearance:none;border:1px solid rgba(148,163,184,.28);background:rgba(148,163,184,.12);color:#e5e7eb;border-radius:10px;padding:6px 10px;font-weight:800}

  /* é®ç½© */
  #sheetBackdrop{display:block;position:fixed;inset:0;background:rgba(2,6,23,.45);
    opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:1650}
  #sheetBackdrop.show{opacity:1;pointer-events:auto}
  body.drawer-open{overflow:hidden}

  /* å³ä¸‹ï¼šé½’è¼ª + Logo ç­‰å¤§å°é½Š */
  .mobile-float{display:flex;gap:10px;position:fixed;right:16px;bottom:16px;z-index:1800;align-items:center}
  .float-btn,.float-logo{
    width:44px;height:44px;border-radius:12px;border:1px solid rgba(148,163,184,.25);
    background:rgba(2,6,23,.65);box-shadow:0 10px 24px rgba(0,0,0,.45)
  }
  .float-btn{display:grid;place-items:center;color:#e5e7eb;font-size:1.1rem}
  .float-logo{object-fit:contain;padding:3px}
  .logo-fixed{display:none}
}
</style>
</head>
<body>
  <header>
    <h1>ğŸ¯ äºŒé …åˆ†å¸ƒæ¨¡æ“¬å™¨ï¼ˆæ•¸ä½é«˜çˆ¾é “æ¿ï¼‰</h1>
    <div class="tools"><button id="btnMusic" title="èƒŒæ™¯éŸ³æ¨‚">ğŸµ</button></div>
  </header>

  <!-- æ¡Œæ©Ÿå³ä¸‹å…¬å¸ Logo -->
  <img class="logo-fixed" src="./company-logo.png" alt="Company Logo"/>

  <div class="wrap">
    <!-- å·¦ï¼šæ¿é¢èˆ‡åœ–è¡¨ -->
    <div>
      <div class="panel canvas-wrap">
        <canvas id="board"></canvas>
        <div class="legend"><span class="dot bar"></span> ç´¯ç©æ¬¡æ•¸ <span class="dot line"></span> ç†è«–äºŒé …åˆ†å¸ƒ</div>
        <div class="stats">
          <div class="stat"><div class="k">ç¸½çƒæ•¸</div><div class="v" id="statTotal">0</div></div>
          <div class="stat"><div class="k">å¯¦éš›å¹³å‡ kÌ„</div><div class="v" id="statMean">0</div></div>
          <div class="stat"><div class="k">ç†è«–å¹³å‡ np</div><div class="v" id="statMeanTh">0</div></div>
          <div class="stat"><div class="k">ç†è«–è®Šç•° np(1âˆ’p)</div><div class="v" id="statVarTh">0</div></div>
        </div>
      </div>
      <div class="panel"><canvas id="chart"></canvas></div>
    </div>

    <!-- å³ï¼šæ§åˆ¶ï¼ˆæ¡Œæ©Ÿï¼‰ï¼æŠ½å±œï¼ˆæ‰‹æ©Ÿï¼‰ -->
    <div class="panel controls-panel" id="controlsWrap">
      <div class="sheet-head" id="sheetHead" style="display:none"></div>
      <div class="controls">
        <div class="control"><label>éšå±¤æ•¸ï¼ˆ3~24ï¼‰</label><input id="levels" type="number" min="3" max="24" value="12"/><input id="levelsR" class="range" type="range" min="3" max="24" value="12"/></div>
        <div class="control"><label>å‘å³æ©Ÿç‡ pï¼ˆ0~1ï¼‰</label><input id="pRight" type="number" min="0" max="1" step="0.01" value="0.5"/><input id="pRightR" class="range" type="range" min="0" max="1" step="0.01" value="0.5"/></div>
        <div class="control"><label>ä¸€æ¬¡ä¸Ÿå¹¾é¡†ï¼ˆ1~200ï¼‰</label><input id="batch" type="number" min="1" max="200" value="12"/><input id="batchR" class="range" type="range" min="1" max="200" value="12"/></div>
        <div class="control"><label>å‡ºçƒé€Ÿåº¦ï¼ˆæ¯ç§’å¹¾æ‰¹ 0.2~20ï¼‰</label><input id="release" type="number" min="0.2" max="20" step="0.1" value="3"/><input id="releaseR" class="range" type="range" min="0.2" max="20" step="0.1" value="3"/></div>
        <div class="control"><label>ä¸‹è½é€Ÿåº¦å€ç‡ï¼ˆ0.2~3ï¼‰</label><input id="fall" type="number" min="0.2" max="3" step="0.1" value="1.2"/><input id="fallR" class="range" type="range" min="0.2" max="3" step="0.1" value="1.2"/></div>
      </div>
      <div class="btns">
        <button class="btn" id="btnDrop">ğŸ¯ æŠ•æ”¾ä¸€æ‰¹</button>
        <button class="btn" id="btnAuto">ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ</button>
        <button class="btn" id="btnPause">â¸ï¸ æš«åœ</button>
        <button class="btn warn" id="btnReset">â™»ï¸ é‡ç½®</button>
      </div>
    </div>
  </div>

  <!-- æ‰‹æ©Ÿå³ä¸‹ï¼šé½’è¼ª + Logo -->
  <div class="mobile-float">
    <button id="btnOpenDrawer" class="float-btn" title="è¨­å®š">âš™ï¸</button>
    <img src="./company-logo.png" alt="Company Logo" class="float-logo"/>
  </div>
  <div id="sheetBackdrop"></div>

  <!-- éŸ³æ¨‚ï¼šç¶­æŒæ—¢æœ‰é‚è¼¯ -->
  <audio id="bgm" src="./bgm.mp3" preload="auto" loop playsinline></audio>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const boardEl=$('board'), chartEl=$('chart');
  const B=boardEl.getContext('2d'), C=chartEl.getContext('2d');

  /* ===== éŸ³æ¨‚ï¼ˆä¸è¦å‹•é‚è¼¯ï¼‰ ===== */
  const bgm=$('bgm'), btnMusic=$('btnMusic');
  function setMusicIcon(){ btnMusic.textContent = bgm.muted ? 'ğŸ”‡' : 'ğŸµ'; btnMusic.classList.toggle('off', bgm.muted); }
  function tryPlayMusic(){ if(!bgm.muted && bgm.paused){ bgm.currentTime = bgm.currentTime || 0; bgm.play().catch(()=>{}); } }
  function pauseMusic(){ if(!bgm.paused) bgm.pause(); }
  function bindTap(el, fn){
    if(!el) return;
    if (window.PointerEvent){ el.addEventListener('pointerup', fn, {passive:true}); }
    else{
      let touched=false;
      el.addEventListener('touchend', e=>{ touched=true; e.preventDefault(); fn(e); }, {passive:false});
      el.addEventListener('click', e=>{ if(touched){ touched=false; return; } fn(e); }, {passive:true});
    }
  }
  bindTap(btnMusic, ()=>{ bgm.muted = !bgm.muted; setMusicIcon(); if(bgm.muted) pauseMusic(); else tryPlayMusic(); });
  setMusicIcon();

  /* ===== åƒæ•¸èˆ‡ç‹€æ…‹ ===== */
  let params={ levels:12, pRight:0.5, batch:12, releaseHz:3, fallSpeed:1.2 };
  ['levels','pRight','batch','release','fall'].forEach(k=>{ $(k).value=params[k]; $(k+'R').value=params[k]; });

  let geom,balls=[],counts=[],total=0,sumK=0,paused=false,auto=false,microQueue=[],emitClock=0;
  let userPaused=false;  // ä½¿ç”¨è€…æ˜¯å¦æŒ‰ä¸‹æš«åœ
  const MAX_ACTIVE=12000, AUTO_GAP=0.85;

  /* ===== å·¥å…· ===== */
  const isMobile = ()=> window.matchMedia('(max-width:980px),(hover:none) and (pointer:coarse)').matches;
  function sizeCanvasToDisplaySize(canvas){
    const DPR=Math.max(1,window.devicePixelRatio||1);
    const rect=canvas.getBoundingClientRect();
    const w=Math.max(2,Math.round(rect.width*DPR));
    const h=Math.max(2,Math.round(rect.height*DPR));
    if(canvas.width!==w||canvas.height!==h){ canvas.width=w; canvas.height=h; }
  }

  /* æ‰‹æ©Ÿï¼šç²¾æº–å›ºå®šæ¿é«˜ â‰ˆ è¦–çª— 50%ï¼ˆä»¥ 12 éšå±¤ç‚ºåŸºæº–ï¼‰ï¼Œchart 25% */
  function fitMobileHeight(){
    if(!isMobile()) return;
    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight) || 600;
    boardEl.style.height = Math.round(vh*0.50) + 'px';
    chartEl.style.height  = Math.round(vh*0.25) + 'px';
// ã€æ–°å¢ã€‘é«˜åº¦å‰›è¨­å®Œç«‹åˆ»åŒæ­¥ canvas å¯¦é«”å°ºå¯¸
    sizeCanvasToDisplaySize(boardEl);
    sizeCanvasToDisplaySize(chartEl);
  }

  function resizeAll(){
    if(isMobile()) fitMobileHeight();   // åªå‹•æ‰‹æ©Ÿé«˜åº¦
    sizeCanvasToDisplaySize(boardEl);
    sizeCanvasToDisplaySize(chartEl);
    build(); drawBoard(); drawChart();
  }
  window.addEventListener('resize', ()=>{ clearTimeout(resizeAll._t); resizeAll._t=setTimeout(resizeAll,90); }, {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', ()=>{ clearTimeout(resizeAll._t); resizeAll._t=setTimeout(resizeAll,90); }, {passive:true});
  }

  /* ===== å¹¾ä½•ï¼šä»¥ 12 ç‚ºåŸºæº–ï¼›n>12 ä¾ 12/n æ¯”ä¾‹å£“ç¸®è¡Œè· ===== */
    /* ===== å¹¾ä½•ï¼šä»¥ 12 ç‚ºåŸºæº–ï¼›æ‰‹æ©Ÿä¸” n=12 æ™‚å¡æ»¿é«˜åº¦ ===== */
  /* ===== å¹¾ä½•ï¼šæ‰‹æ©Ÿå›ºå®šæ¿é«˜ï¼›n=12 åƒæ»¿ï¼Œé«˜æ–¼ 12 åªç¸®é–“è· ===== */
function build(){
  const W=boardEl.width, H=boardEl.height, n=params.levels;
  const m = { top:20, bottom:isMobile()?10:18, left:14, right:14 };

  const bw = Math.max(10, W - m.left - m.right);
  const px = Math.min(30, Math.max(10, bw/(n+2)));
  const dx = px/2;

  const cx = W/2, sy = m.top + 6;
  const floor = H - m.bottom - 6;

  const targetRef = 12;                   // é›»è…¦ç‰ˆåŸºæº–
  const mobileTight = isMobile();         // åªå½±éŸ¿æ‰‹æ©Ÿï¼šæ¿é¢é«˜åº¦å›ºå®š

  // å…ˆä»¥ pegR â‰ˆ2.5 é ä¼°ä¸€æ¬¡ï¼Œä¹‹å¾Œå†ç”¨çœŸæ­£ pegR å›å¡«ä¸€æ¬¡ï¼Œé¿å…è¢«åº•ç·šã€Œé ‚å›å»ã€
  const guessPeg = 2.5;
  const spanBase = (floor - sy - (mobileTight ? 2 : 10)); // æ‰‹æ©Ÿä¸ç•™é¡å¤–å®‰å…¨è·
  let ry0;

  if (mobileTight) {
    // æ‰‹æ©Ÿï¼šæ¿é¢å›ºå®šã€‚n=12 â†’ åƒæ»¿ï¼›n>12 â†’ æŒ‰ 12/n ç­‰æ¯”ç¸® ry
    const ryBase0 = Math.max(6, Math.min(36, (floor - sy - guessPeg - 2) / targetRef));
    ry0 = (n <= targetRef) ? ryBase0 : ryBase0 * (targetRef / Math.max(1,n));
  } else {
    // æ¡Œæ©Ÿï¼šç¶­æŒåŸæœ¬é‚è¼¯ï¼ˆä»¥ 12 ç‚ºåŸºæº–ï¼Œn>12 ç¸® ryï¼‰
    let baseRy = Math.max(6, Math.min(36, spanBase / targetRef));
    ry0 = baseRy * Math.min(1, targetRef/Math.max(1,n));
  }

  // ç”¨ ry0 ç®—çœŸæ­£ pegRï¼Œå†å›å¡«ä¸€æ¬¡ï¼Œç¢ºä¿çƒä¸æœƒç©¿å‡ºåº•ç·šï¼ŒåŒæ™‚ n=12 æ™‚åƒæ»¿
  let pegR = Math.min(3, Math.max(2, ry0 * 0.22));
  let ry;
  if (mobileTight) {
    const ryBase = Math.max(6, Math.min(36, (floor - sy - pegR - 2) / targetRef));
    ry = (n <= targetRef) ? ryBase : ryBase * (targetRef / Math.max(1,n));
    // æ‰‹æ©Ÿæ¨¡å¼ï¼šä¸è¦å†ç”¨ maxRy æŠŠå®ƒå£“å°ï¼Œé¿å… 12 éšå±¤åƒä¸æ»¿
  } else {
    ry = ry0;
    // æ¡Œæ©Ÿä¿å®ˆæª¢æŸ¥
    const maxRy = (floor - (pegR + 6) - sy) / Math.max(1, n);
    if (ry > maxRy) ry = Math.max(6, maxRy);
  }

  // é‡˜å­åŠå¾‘ï¼ˆä¾æœ€çµ‚ ryï¼‰
  pegR = Math.min(3, Math.max(2, ry * 0.22));

  const slots = Array.from({length:n+1},(_,k)=> cx-(n*dx)+k*px);
  const pegs=[];
  for(let r=0;r<n;r++){
    const y = sy + (r+1)*ry;
    const row=[]; for(let j=0;j<=r;j++) row.push({x:cx-(r*dx)+j*px,y});
    pegs.push(row);
  }

  geom={W,H,m,n,cx,sy,ry,dx,px,slots,pegs,floor,pegR};

  counts=Array(n+1).fill(0);
  total=0; sumK=0; balls=[]; microQueue=[]; emitClock=0;
  scheduleChart(); updateStats();
}



  /* ===== ç¹ªæ¿ï¼šæ§½ç·šå›ºå®š 10pxï¼Œåš´å®ˆæ¡†å…§ ===== */
  function drawBoard(){
    const g=geom,ctx=B;
    ctx.clearRect(0,0,g.W,g.H);
    ctx.fillStyle='#081029'; ctx.fillRect(0,0,g.W,g.H);

    // å¤–æ¡†
    ctx.strokeStyle='rgba(148,163,184,.35)';
    ctx.strokeRect(g.m.left,g.m.top,g.W-g.m.left-g.m.right,g.H-g.m.top-g.m.bottom);

    // é‡˜å­
    ctx.fillStyle='rgba(148,163,184,.85)';
    for(const row of g.pegs){
      for(const p of row){ ctx.beginPath(); ctx.arc(p.x,p.y,g.pegR,0,2*Math.PI); ctx.fill(); }
    }

    // å…§æ¡†ç•Œç·š
    const innerTop = g.m.top + 1;
    const innerBottom = g.H - g.m.bottom - 2;

    // åŸºæº–ç·š
    const baseY = Math.min(g.floor + 0.5, innerBottom - 0.5);
    ctx.beginPath(); ctx.moveTo(g.m.left, baseY); ctx.lineTo(g.W-g.m.right, baseY); ctx.stroke();

    // æ§½ç·šï¼ˆ10pxï¼‰
    const slotLen = 10;
    const startY = Math.max(innerTop + 1, Math.min(g.floor + 2, innerBottom - slotLen - 1));
    const endY   = startY + slotLen;
    ctx.strokeStyle='rgba(56,189,248,.35)';
    for(const x of g.slots){ ctx.beginPath(); ctx.moveTo(x, startY); ctx.lineTo(x, endY); ctx.stroke(); }

    // çƒ
    ctx.fillStyle='rgba(56,189,248,.92)';
    for(const b of balls){
      const a=b.pts[b.seg], c=b.pts[b.seg+1]||a;
      const x=a.x+(c.x-a.x)*b.t, y=a.y+(c.y-a.y)*b.t;
      ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill();
    }
  }

  /* ===== çµ±è¨ˆåœ– ===== */
  function logF(n){ if(!logF.c){logF.c=[0,0];} const c=logF.c; for(let i=c.length;i<=n;i++) c[i]=c[i-1]+Math.log(i); return c[n]; }
  function pmf(n,k,p){ if(k<0||k>n) return 0; if(p===0) return k===0?1:0; if(p===1) return k===n?1:0;
    return Math.exp(logF(n)-logF(k)-logF(n-k)+k*Math.log(p)+(n-k)*Math.log(1-p)); }
  let chartTimer=null; function scheduleChart(){ if(chartTimer) return; chartTimer=setTimeout(()=>{ chartTimer=null; drawChart(); },80); }
  function drawChart(){
    const ctx=C, W=chartEl.width, H=chartEl.height, pad=32, n=params.levels;
    const data=counts.slice(); const theo=Array.from({length:n+1},(_,k)=> total*pmf(n,k,params.pRight));
    const ymax=Math.max(1, ...data, ...theo);
    ctx.clearRect(0,0,W,H); ctx.fillStyle='#0b1224'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='rgba(148,163,184,.25)'; for(let i=0;i<=3;i++){ const y=pad+(H-pad-12)*i/3; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke(); }
    const plotW=W-pad-10, plotH=H-pad-12, barW=plotW/(n+1)*0.78, gap=plotW/(n+1)*0.22;
    for(let k=0;k<=n;k++){ const x=pad+k*(barW+gap)+gap*0.5, h=(data[k]/ymax)*plotH; ctx.fillStyle='rgba(56,189,248,.75)'; ctx.fillRect(x, pad+plotH-h, barW, h); }
    ctx.strokeStyle='rgba(248,113,113,1)'; ctx.lineWidth=1.6; ctx.beginPath();
    for(let k=0;k<=n;k++){ const x=pad+k*(barW+gap)+(gap*0.5+barW/2), y=pad+plotH-(theo[k]/ymax)*plotH; k?ctx.lineTo(x,y):ctx.moveTo(x,y); }
    ctx.stroke();
  }

  /* ===== æ¨¡æ“¬æ ¸å¿ƒ ===== */
  function makeBall(){
    const g=geom; let r=0;
    const pts=[{x:g.cx,y:g.sy}];
    for(let s=1;s<=g.n;s++){ if(Math.random()<params.pRight) r++; pts.push({x:g.cx+(2*r-s)*g.dx,y:g.sy+s*g.ry}); }
    pts.push({x:g.slots[r],y:g.floor});
    return {pts,seg:0,t:0,spd:140*params.fallSpeed,bin:r};
  }
  function microStagger(){ return Math.max(.005, Math.min(.03, .3/Math.max(1, params.batch))); }
  function scheduleBatch(){ const want=Math.max(1, Math.floor(params.batch)), s=microStagger(); for(let i=0;i<want;i++) microQueue.push(i*s); }

  /* ===== è¿´åœˆ ===== */
  let last=0;
  function tick(ts){
    if(!last) last=ts; const dt=Math.min(.05,(ts-last)/1000); last=ts;
    if(!paused){
      const base=1/Math.max(.1, params.releaseHz);
      emitClock-=dt;
      while(emitClock<=0){ if(auto) scheduleBatch(); emitClock += (auto? base*AUTO_GAP : base); }

      // é€é¡†å¾®æ™‚å·®å‡ºçƒ
      for(let i=0;i<microQueue.length;){
        microQueue[i]-=dt;
        if(microQueue[i]<=0){
          if(balls.length<MAX_ACTIVE){
            const wasEmpty=(balls.length===0 && total===0);
            balls.push(makeBall());
            if(wasEmpty) tryPlayMusic();
            microQueue.splice(i,1);
            continue;
          }
        }
        i++;
      }

      // çƒç§»å‹•
      for(let i=balls.length-1;i>=0;i--){
        const b=balls[i], a=b.pts[b.seg], c=b.pts[b.seg+1];
        if(!c){ counts[b.bin]++; total++; sumK+=b.bin; balls.splice(i,1); scheduleChart(); updateStats(); continue; }
        const L=Math.max(1, Math.hypot(c.x-a.x, c.y-a.y));
        b.t += (b.spd*params.fallSpeed*dt)/L;
        if(b.t>=1){ b.seg++; b.t=0; }
      }

      // é—œè‡ªå‹•ï¼šä¸æ–°å¢ï¼Œè®“ä½‡åˆ—èˆ‡ç©ºä¸­çƒè·‘å®Œï¼›å…¨æ¸…å¾Œè‡ªå‹•æš«åœéŸ³æ¨‚
      if(!auto && microQueue.length===0 && balls.length===0) pauseMusic();
    }
    drawBoard();
    requestAnimationFrame(tick);
  }

  /* ===== çµ±è¨ˆ ===== */
  function updateStats(){
    $('statTotal').textContent=total;
    $('statMean').textContent= total? (sumK/total).toFixed(3) : '0';
    $('statMeanTh').textContent=(params.levels*params.pRight).toFixed(3);
    $('statVarTh').textContent=(params.levels*params.pRight*(1-params.pRight)).toFixed(3);
  }

  /* ===== æ§åˆ¶åŒæ­¥ ===== */
  function link(num,range,on){
    const n=$(num), r=$(range); const set=v=>{ n.value=v; r.value=v; on(+v); };
    n.addEventListener('input',e=>set(e.target.value),{passive:true});
    r.addEventListener('input',e=>set(e.target.value),{passive:true});
  }
  // æ‰‹æ©Ÿéœ€è¦é‡æ–°å£“è¡Œè· â†’ ç”¨ resizeAll()
  link('levels','levelsR', v=>{ params.levels=v|0; resizeAll(); });
  link('pRight','pRightR', v=>{ params.pRight=+v; scheduleChart(); updateStats(); });
  link('batch','batchR', v=>{ params.batch=+v; });
  link('release','releaseR', v=>{ params.releaseHz=+v; });
  link('fall','fallR', v=>{ params.fallSpeed=+v; });

  /* ===== æ‰‹æ©ŸæŠ½å±œï¼ˆä¸å½±éŸ¿æ¡Œæ©Ÿï¼‰===== */
  const wrap=$('controlsWrap'), mask=$('sheetBackdrop'), head=$('sheetHead');
  function openDrawer(open){
    if(!isMobile()) return;
    wrap.classList.toggle('open',open);
    mask.classList.toggle('show',open);
    document.body.classList.toggle('drawer-open',open);
    head.style.display = open ? 'flex' : 'none';
    if(open){
      head.innerHTML='<div class="sheet-title">âš™ï¸ æ§åˆ¶é¢æ¿</div><button class="sheet-close" id="btnSheetClose">âœ•</button>';
      document.getElementById('btnSheetClose').addEventListener('pointerup',()=>openDrawer(false),{passive:true});
      // æŠ½å±œé–‹å•Ÿæ™‚å…ˆæš«åœï¼Œä½†ä¸æ”¹ userPaused ç‹€æ…‹
      if(!paused){ paused=true; $('btnPause').textContent='â–¶ï¸ ç¹¼çºŒ'; }
    }
  }
  function closeDrawerIfOpen(){
    if(isMobile() && wrap.classList.contains('open')){
      openDrawer(false);
      // è‹¥ä½¿ç”¨è€…ã€Œæ²’æœ‰ã€ä¸»å‹•æŒ‰éæš«åœï¼Œå°±è‡ªå‹•æ¢å¾©æ’­æ”¾ï¼Œé¿å…é—œè‡ªå‹•æ™‚å¡ä½
      if(!userPaused){ paused=false; $('btnPause').textContent='â¸ï¸ æš«åœ'; }
    }
  }
  const btnOpenDrawer=document.getElementById('btnOpenDrawer');
  if(btnOpenDrawer){ bindTap(btnOpenDrawer, ()=>openDrawer(true)); }
  mask.addEventListener('pointerup', ()=>openDrawer(false), {passive:true});

  /* ===== ä¸»æŒ‰éˆ• ===== */
  bindTap($('btnDrop'), ()=>{ paused=false; userPaused=false; $('btnPause').textContent='â¸ï¸ æš«åœ'; scheduleBatch(); tryPlayMusic(); closeDrawerIfOpen(); });

  bindTap($('btnAuto'), (e)=>{
    auto=!auto;
    if(!auto){
      e.target.textContent='ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ';
      // é—œè‡ªå‹•ä½†ä¸æ¸…ä½‡åˆ—ï¼Œä¸”è‹¥éä½¿ç”¨è€…æš«åœå°±ä¿æŒæ’­æ”¾ï¼Œè®“çƒå…¨éƒ¨è·‘å®Œ
      if(!userPaused){ paused=false; $('btnPause').textContent='â¸ï¸ æš«åœ'; }
      // è‹¥ä½ åå¥½ã€Œé—œè‡ªå‹•æ™‚è£œæŠ•ä¸€æ‰¹ã€å¯è§£é–‹ä¸‹ä¸€è¡Œï¼š
      // scheduleBatch();
    }else{
      e.target.textContent='ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé–‹';
      paused=false; userPaused=false; $('btnPause').textContent='â¸ï¸ æš«åœ';
      emitClock=0; scheduleBatch(); tryPlayMusic();
    }
    closeDrawerIfOpen();
  });

  bindTap($('btnPause'), (e)=>{
    userPaused = !userPaused;
    paused = userPaused;
    e.target.textContent = paused ? 'â–¶ï¸ ç¹¼çºŒ' : 'â¸ï¸ æš«åœ';
    if(!paused) tryPlayMusic();
    closeDrawerIfOpen();
  });

  bindTap($('btnReset'), ()=>{
    auto=false; $('btnAuto').textContent='ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ';
    microQueue.length=0; balls.length=0; pauseMusic();
    userPaused=false; paused=false; $('btnPause').textContent='â¸ï¸ æš«åœ';
    build(); drawBoard(); drawChart(); setMusicIcon(); closeDrawerIfOpen();
  });

  /* ===== å•Ÿå‹• ===== */
  boardEl.style.width='100%'; chartEl.style.width='100%';
  boardEl.style.height='46vh'; chartEl.style.height='22vh';
  if(isMobile()){ fitMobileHeight(); } // æ‰‹æ©Ÿå…ˆå£“æˆ 50% + 25%
  resizeAll(); requestAnimationFrame(tick);
})();
</script>
</body>
</html>
