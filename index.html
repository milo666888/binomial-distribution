<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>äºŒé …åˆ†å¸ƒæ¨¡æ“¬å™¨ï¼ˆæ•¸ä½é«˜çˆ¾é “æ¿ï¼‰</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--accent:#38bdf8;--accent2:#f87171;--text:#e5e7eb;--muted:#94a3b8}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Microsoft JhengHei",Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
background:linear-gradient(180deg,#0b1025 0%, #0f172a 60%, #0b1025 100%)}
header{padding:10px 12px 4px;text-align:center;position:relative}
h1{margin:0;font-size:1.6rem;font-weight:800;color:#f0f9ff}

/* éŸ³æ¨‚é–‹é—œï¼ˆå³ä¸Šè§’ï¼‰ */
#btnMusic{
  position:absolute;right:14px;top:12px;
  background:none;border:none;font-size:1.55rem;color:#e5e7eb;cursor:pointer;
  filter:drop-shadow(0 0 3px rgba(0,0,0,.5));z-index:70
}
#btnMusic.off{opacity:.6;text-decoration:line-through}

/* ä¸»è¦ç‰ˆé¢ï¼šæ¡Œæ©Ÿé›™æ¬„ */
.wrap{max-width:1100px;margin:14px auto 28px;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:12px}
.panel{background:rgba(31,41,55,.85);border:1px solid rgba(148,163,184,.2);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);
backdrop-filter:blur(6px);padding:12px}
.canvas-wrap{position:relative;padding:10px;border-radius:12px;
background:radial-gradient(1000px 360px at 50% -40%, rgba(56,189,248,.15), transparent 60%),
linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
border:1px solid rgba(148,163,184,.2)}
#board{display:block;width:900px;height:520px;border-radius:10px;background:#0a0f1f}
#chart{display:block;width:900px;height:220px;border-radius:10px;background:#0b1224}

.legend{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:.85rem;margin-top:6px}
.dot{width:12px;height:12px;border-radius:999px;display:inline-block}
.bar{background:var(--accent)} .line{background:var(--accent2)}
.stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:6px}
.stat{padding:8px 10px;border-radius:10px;background:rgba(2,6,23,.4);border:1px solid rgba(148,163,184,.2)}
.stat .k{font-size:.75rem;color:var(--muted)} .stat .v{font-weight:700}

/* æ§åˆ¶å€ */
.controls{padding:12px;display:grid;gap:12px;background:rgba(2,6,23,.35);
border:1px dashed rgba(148,163,184,.25);border-radius:12px}
.control{display:grid;gap:8px}
.control label{font-size:.85rem;color:var(--muted)}
.control input[type=number]{background:var(--card);color:var(--text);border:1px solid rgba(148,163,184,.35);
border-radius:8px;padding:6px 10px}
.range{appearance:none;width:100%;height:6px;border-radius:6px;background:rgba(148,163,184,.22)}
.range::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent)}
.range::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);border:none}
.btns{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
.btn{appearance:none;border:1px solid rgba(148,163,184,.35);
background:linear-gradient(180deg,rgba(56,189,248,.18),rgba(56,189,248,.08));
color:#e6f7ff;padding:9px 13px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.warn{background:linear-gradient(180deg,rgba(248,113,113,.22),rgba(248,113,113,.10));
border-color:rgba(248,113,113,.45);color:#ffecec}

/* Logoï¼ˆå³ä¸‹å›ºå®šï¼‰ */
.logo-fixed{position:fixed;right:16px;bottom:16px;width:90px;height:auto;opacity:.95;
filter:drop-shadow(0 6px 16px rgba(0,0,0,.45));pointer-events:none;z-index:50}

/* æ‰‹æ©Ÿï¼šå–®æ¬„ï¼‹æŠ½å±œé¸å–®ï¼›æ–‡å­—å†å°ä¸€äº› */
#fabCtrl{display:none}
#sheetBackdrop{display:none}
@media (max-width:980px),(hover:none) and (pointer:coarse){
  h1{font-size:1.08rem}
  .wrap{grid-template-columns:1fr}
  .panel{padding:8px}
  .legend{font-size:.78rem}
  .controls label{font-size:.78rem}
  .controls input[type=number]{font-size:.78rem}
  .btn{font-size:.78rem;padding:6px 9px}
  .logo-fixed{width:58px;right:10px;bottom:10px}
  #board,#chart{width:100%;height:auto}

  /* æŠ½å±œï¼ˆbottom sheetï¼‰ */
  .controls-panel{
    position:fixed;left:0;right:0;bottom:0;z-index:60;max-height:85vh;
    transform:translateY(105%);transition:transform .25s ease;
    border-radius:16px 16px 0 0;backdrop-filter:blur(8px);overflow:hidden;padding-top:6px
  }
  .controls-panel.open{transform:translateY(0)}
  .sheet-head{display:flex;justify-content:space-between;align-items:center;padding:6px 12px 2px 12px}
  .sheet-title{font-weight:800}
  .sheet-close{appearance:none;border:1px solid rgba(148,163,184,.28);background:rgba(148,163,184,.12);color:#e5e7eb;border-radius:10px;padding:6px 10px;font-weight:800}
  .controls{max-height:60vh;overflow:auto;-webkit-overflow-scrolling:touch}
  .btns{position:sticky;bottom:0;background:rgba(2,6,23,.55);border-top:1px solid rgba(148,163,184,.15);padding-top:8px}

  /* é½’è¼ª FAB è®“ä½çµ¦ logoï¼ˆå¾€å·¦é€€ï¼‰ */
  #fabCtrl{
    display:grid;place-items:center;position:fixed;right:84px;bottom:16px;z-index:65;
    width:52px;height:52px;border-radius:999px;border:1px solid rgba(148,163,184,.35);
    background:radial-gradient(120% 120% at 70% 20%,rgba(56,189,248,.35),rgba(31,41,55,.9));
    color:#e6f7ff;font-size:1.2rem;font-weight:900;box-shadow:0 10px 24px rgba(0,0,0,.45)
  }
  #sheetBackdrop{display:block;position:fixed;inset:0;background:rgba(2,6,23,.45);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:55}
  #sheetBackdrop.show{opacity:1;pointer-events:auto}
  body.drawer-open{overflow:hidden}
}
</style>
</head>
<body>
<header>
  <h1>ğŸ¯ äºŒé …åˆ†å¸ƒæ¨¡æ“¬å™¨ï¼ˆæ•¸ä½é«˜çˆ¾é “æ¿ï¼‰</h1>
  <button id="btnMusic" title="èƒŒæ™¯éŸ³æ¨‚">ğŸµ</button>
</header>

<img class="logo-fixed" src="./å…¬å¸æ¨™èªŒ.png" alt="Company Logo"/>

<div class="wrap">
  <!-- å·¦ï¼šæ¿å­ + çµæœåœ– -->
  <div>
    <div class="panel canvas-wrap">
      <canvas id="board" width="900" height="520"></canvas>
      <div class="legend"><span class="dot bar"></span> ç´¯ç©æ¬¡æ•¸ <span class="dot line"></span> ç†è«–äºŒé …åˆ†å¸ƒ</div>
      <div class="stats">
        <div class="stat"><div class="k">ç¸½çƒæ•¸</div><div class="v" id="statTotal">0</div></div>
        <div class="stat"><div class="k">å¯¦éš›å¹³å‡ kÌ„</div><div class="v" id="statMean">0</div></div>
        <div class="stat"><div class="k">ç†è«–å¹³å‡ np</div><div class="v" id="statMeanTh">0</div></div>
        <div class="stat"><div class="k">ç†è«–è®Šç•° np(1âˆ’p)</div><div class="v" id="statVarTh">0</div></div>
      </div>
    </div>
    <div class="panel"><canvas id="chart" width="900" height="220"></canvas></div>
  </div>

  <!-- å³ï¼šæ§åˆ¶ï¼ˆæ¡Œæ©Ÿï¼‰ï¼æŠ½å±œï¼ˆæ‰‹æ©Ÿï¼‰ -->
  <div class="panel controls-panel" id="controlsWrap">
    <div class="sheet-head" id="sheetHead" style="display:none"></div>
    <div class="controls">
      <div class="control"><label>éšå±¤æ•¸ï¼ˆ3~24ï¼‰</label><input id="levels" type="number" min="3" max="24" value="12"/><input id="levelsR" class="range" type="range" min="3" max="24" value="12"/></div>
      <div class="control"><label>å‘å³æ©Ÿç‡ pï¼ˆ0~1ï¼‰</label><input id="pRight" type="number" min="0" max="1" step="0.01" value="0.5"/><input id="pRightR" class="range" type="range" min="0" max="1" step="0.01" value="0.5"/></div>
      <div class="control"><label>ä¸€æ¬¡ä¸Ÿå¹¾é¡†ï¼ˆ1~200ï¼‰</label><input id="batch" type="number" min="1" max="200" value="12"/><input id="batchR" class="range" type="range" min="1" max="200" value="12"/></div>
      <div class="control"><label>å‡ºçƒé€Ÿåº¦ï¼ˆæ¯ç§’å¹¾æ‰¹ 0.2~20ï¼‰</label><input id="release" type="number" min="0.2" max="20" step="0.1" value="3"/><input id="releaseR" class="range" type="range" min="0.2" max="20" step="0.1" value="3"/></div>
      <div class="control"><label>ä¸‹è½é€Ÿåº¦å€ç‡ï¼ˆ0.2~3ï¼‰</label><input id="fall" type="number" min="0.2" max="3" step="0.1" value="1.2"/><input id="fallR" class="range" type="range" min="0.2" max="3" step="0.1" value="1.2"/></div>
    </div>
    <div class="btns">
      <button class="btn" id="btnDrop">ğŸ¯ æŠ•æ”¾ä¸€æ‰¹</button>
      <button class="btn" id="btnAuto">ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ</button>
      <button class="btn" id="btnPause">â¸ï¸ æš«åœ</button>
      <button class="btn warn" id="btnReset">â™»ï¸ é‡ç½®</button>
    </div>
  </div>
</div>

<!-- æ‰‹æ©Ÿï¼šé½’è¼ªèˆ‡é®ç½©ï¼ˆæŠ½å±œé–‹é—œï¼‰ -->
<button id="fabCtrl">âš™ï¸</button>
<div id="sheetBackdrop"></div>

<!-- éŸ³æ¨‚ï¼ˆä½ çš„æª”åæ˜¯ bgm.MP3ï¼‰ -->
<audio id="bgm" src="./bgm.MP3" preload="auto" loop></audio>

<script>
(function(){
const $=id=>document.getElementById(id);
const boardEl=$('board'), chartEl=$('chart');
const B=boardEl.getContext('2d'), C=chartEl.getContext('2d');

/* === éŸ³æ¨‚ï¼šé€²ç«™å³å˜—è©¦æ’­æ”¾ + å³ä¸Š icon å¯åˆ‡æ›ï¼›è‹¥è¢«ç€è¦½å™¨æ“‹ä½é¡¯ç¤ºæç¤ºä¸¦ç­‰å¾…é»æ“Š === */
const bgm=$('bgm'), btnMusic=$('btnMusic');
let musicOn=true;   // é è¨­ä¸€é–‹å§‹å°±è¦æ’­
function setMusicUI(){
  if(musicOn){ btnMusic.textContent='ğŸ”‡'; btnMusic.classList.add('off'); }
  else{ btnMusic.textContent='ğŸµ'; btnMusic.classList.remove('off'); }
}
async function tryAutoplay(){
  if(!musicOn) return;
  try{ await bgm.play(); } catch(e){ /* è¢«æ“‹ä½å°±ç­‰äº’å‹•å†æ’­ */ }
}
btnMusic.addEventListener('click',()=>{
  musicOn=!musicOn;
  setMusicUI();
  if(musicOn){ bgm.play().catch(()=>{}); } else { bgm.pause(); }
});
document.addEventListener('pointerdown',()=>{ if(musicOn && bgm.paused){ bgm.play().catch(()=>{}); } },{once:true});
document.addEventListener('keydown',()=>{ if(musicOn && bgm.paused){ bgm.play().catch(()=>{}); } },{once:true});
tryAutoplay();

/* === åƒæ•¸èˆ‡ç‹€æ…‹ === */
let params={levels:+$('levels').value,pRight:+$('pRight').value,batch:+$('batch').value,releaseHz:+$('release').value,fallSpeed:+$('fall').value};
let geom,balls=[],counts=[],total=0,sumK=0,paused=false,auto=false,microQueue=[],queueBatches=0,emitClock=0;
const MAX_ACTIVE=12000,AUTO_GAP=0.85;

/* === å¹¾ä½• === */
function build(){
  const W=boardEl.width,H=boardEl.height,n=params.levels;
  const m={top:24,bottom:90,left:24,right:24};
  const bw=W-m.left-m.right,bh=H-m.top-m.bottom;
  const px=Math.min(28,Math.max(12,bw/(n+2))),ry=Math.max(16,Math.min(36,bh/(n+2)));
  const cx=W/2,sy=m.top+8,dx=px/2,slots=Array.from({length:n+1},(_,k)=>cx-(n*dx)+k*px);
  const pegs=[];for(let r=0;r<n;r++){const y=sy+(r+1)*ry,row=[];for(let j=0;j<=r;j++)row.push({x:cx-(r*dx)+j*px,y});pegs.push(row);}
  geom={W,H,m,n,cx,sy,ry,dx,px,slots,pegs,floor:sy+(n+1)*ry};
  counts=Array(n+1).fill(0); total=0; sumK=0; balls=[]; microQueue=[]; queueBatches=0; emitClock=0;
  scheduleChart(); updateStats();
}

/* === ç•«æ¿ === */
function drawBoard(){
  const g=geom,ctx=B;
  ctx.clearRect(0,0,g.W,g.H);
  ctx.fillStyle='#081029'; ctx.fillRect(0,0,g.W,g.H);
  ctx.strokeStyle='rgba(148,163,184,.35)'; ctx.lineWidth=1.2;
  ctx.strokeRect(g.m.left,g.m.top,g.W-g.m.left-g.m.right,g.H-g.m.top-g.m.bottom);
  ctx.fillStyle='rgba(148,163,184,.85)';
  for(const row of g.pegs){ for(const p of row){ ctx.beginPath(); ctx.arc(p.x,p.y,3,0,2*Math.PI); ctx.fill(); } }
  ctx.strokeStyle='rgba(56,189,248,.35)';
  for(const x of g.slots){ ctx.beginPath(); ctx.moveTo(x,g.floor); ctx.lineTo(x,g.floor-16); ctx.stroke(); }
  ctx.fillStyle='rgba(56,189,248,.92)';
  for(const b of balls){ const a=b.pts[b.seg], c=b.pts[b.seg+1]||a; const x=a.x+(c.x-a.x)*b.t, y=a.y+(c.y-a.y)*b.t;
    ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill();
  }
}

/* === çµæœåœ– === */
function logF(n){ if(!logF.c){logF.c=[0,0];} const c=logF.c; for(let i=c.length;i<=n;i++) c[i]=c[i-1]+Math.log(i); return c[n]; }
function pmf(n,k,p){ if(k<0||k>n) return 0; if(p===0) return k===0?1:0; if(p===1) return k===n?1:0; return Math.exp(logF(n)-logF(k)-logF(n-k)+k*Math.log(p)+(n-k)*Math.log(1-p)); }
let chartTimer=null;
function scheduleChart(){ if(chartTimer) return; chartTimer=setTimeout(()=>{ chartTimer=null; drawChart(); },80); }
function drawChart(){
  const ctx=C, W=chartEl.width, H=chartEl.height, pad=36, n=params.levels;
  const data=counts.slice();
  const theo=Array.from({length:n+1},(_,k)=> total*pmf(n,k,params.pRight));
  const ymax=Math.max(1, ...data, ...theo);
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#0b1224'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(148,163,184,.25)';
  for(let i=0;i<=4;i++){ const y=pad+(H-pad-16)*i/4; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-10,y); ctx.stroke(); }
  const plotW=W-pad-10, plotH=H-pad-16, barW=plotW/(n+1)*0.8, gap=plotW/(n+1)*0.2;
  for(let k=0;k<=n;k++){
    const x=pad+k*(barW+gap)+gap*0.5, h=(data[k]/ymax)*plotH;
    ctx.fillStyle='rgba(56,189,248,.75)'; ctx.fillRect(x, pad+plotH-h, barW, h);
  }
  ctx.strokeStyle='rgba(248,113,113,1)'; ctx.lineWidth=1.8; ctx.beginPath();
  for(let k=0;k<=n;k++){
    const x=pad+k*(barW+gap)+(gap*0.5+barW/2);
    const y=pad+plotH-(theo[k]/ymax)*plotH;
    k?ctx.lineTo(x,y):ctx.moveTo(x,y);
  }
  ctx.stroke();
}

/* === æ¨¡æ“¬æ ¸å¿ƒ === */
function makeBall(){ const g=geom; let r=0; const pts=[{x:g.cx,y:g.sy}];
  for(let s=1;s<=g.n;s++){ if(Math.random()<params.pRight) r++; pts.push({x:g.cx+(2*r-s)*g.dx,y:g.sy+s*g.ry}); }
  pts.push({x:g.slots[r],y:g.floor}); return {pts,seg:0,t:0,spd:140*params.fallSpeed,bin:r}; }
function microStagger(){ return Math.max(.005, Math.min(.03, .3/Math.max(1, params.batch))); }
function scheduleBatch(){ const want=Math.max(1, Math.floor(params.batch)), s=microStagger(); for(let i=0;i<want;i++) microQueue.push(i*s); }

let last=0;
function tick(ts){
  if(!last) last=ts;
  const dt=Math.min(.05,(ts-last)/1000); last=ts;

  if(!paused){
    const base=1/Math.max(.1, params.releaseHz);
    emitClock-=dt;
    while(emitClock<=0){ if(auto) scheduleBatch(); if(queueBatches>0){ scheduleBatch(); queueBatches--; } emitClock += (auto? base*AUTO_GAP : base); }
    for(let i=0;i<microQueue.length;){ microQueue[i]-=dt; if(microQueue[i]<=0){ if(balls.length<MAX_ACTIVE){ balls.push(makeBall()); microQueue.splice(i,1); continue; } } i++; }
    for(let i=balls.length-1;i>=0;i--){
      const b=balls[i], a=b.pts[b.seg], c=b.pts[b.seg+1];
      if(!c){ counts[b.bin]++; total++; sumK+=b.bin; balls.splice(i,1); scheduleChart(); updateStats(); continue; }
      const L=Math.max(1, Math.hypot(c.x-a.x, c.y-a.y));
      b.t += (b.spd*params.fallSpeed*dt)/L;
      if(b.t>=1){ b.seg++; b.t=0; }
    }
  }

  drawBoard();
  requestAnimationFrame(tick);
}

/* === çµ±è¨ˆ === */
function updateStats(){
  $('statTotal').textContent=total;
  $('statMean').textContent= total? (sumK/total).toFixed(3) : '0';
  $('statMeanTh').textContent=(params.levels*params.pRight).toFixed(3);
  $('statVarTh').textContent=(params.levels*params.pRight*(1-params.pRight)).toFixed(3);
}

/* === æ§åˆ¶åŒæ­¥ === */
function syncPair(num,range,on){
  const n=$(num), r=$(range);
  const set=v=>{ n.value=v; r.value=v; on(+v); };
  n.addEventListener('input',e=>set(e.target.value));
  r.addEventListener('input',e=>set(e.target.value));
}
syncPair('levels','levelsR', v=>{ params.levels=v|0; build(); });
syncPair('pRight','pRightR', v=>{ params.pRight=+v; scheduleChart(); updateStats(); });
syncPair('batch','batchR', v=>{ params.batch=+v; });
syncPair('release','releaseR', v=>{ params.releaseHz=+v; });
syncPair('fall','fallR', v=>{ params.fallSpeed=+v; });

/* === æŒ‰éˆ• === */
$('btnDrop').addEventListener('click', ()=>{ queueBatches++; });
$('btnAuto').addEventListener('click', e=>{ auto=!auto; e.target.textContent=auto?'ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé–‹':'ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ'; });
$('btnPause').addEventListener('click', e=>{ paused=!paused; e.target.textContent=paused?'â–¶ï¸ ç¹¼çºŒ':'â¸ï¸ æš«åœ'; });
$('btnReset').addEventListener('click', ()=>{ auto=false; $('btnAuto').textContent='ğŸ” è‡ªå‹•æŠ•æ”¾ï¼šé—œ'; build(); });

/* === æ‰‹æ©ŸæŠ½å±œï¼ˆé½’è¼ªï¼‰ === */
const wrap=$('controlsWrap'), fab=$('fabCtrl'), mask=$('sheetBackdrop'), head=$('sheetHead');
function isMobile(){ return window.matchMedia('(max-width:980px),(hover:none) and (pointer:coarse)').matches; }
function openDrawer(open){
  if(!isMobile()) return;
  wrap.classList.toggle('open',open);
  mask.classList.toggle('show',open);
  document.body.classList.toggle('drawer-open',open);
}
function refreshDrawerHeader(){
  if(isMobile()){
    head.style.display='flex';
    head.innerHTML = '<div class="sheet-title">âš™ï¸ æ§åˆ¶é¢æ¿</div><button class="sheet-close" id="btnSheetClose">âœ•</button>';
    const closeBtn = document.getElementById('btnSheetClose');
    closeBtn.addEventListener('click',()=>openDrawer(false));
  }else{
    head.style.display='none';
  }
}
fab.addEventListener('click',()=>openDrawer(true));
mask.addEventListener('click',()=>openDrawer(false));
window.addEventListener('resize',refreshDrawerHeader);
refreshDrawerHeader();

/* === å•Ÿå‹• === */
build();
requestAnimationFrame(tick);
})();
</script>
</body>
</html>
